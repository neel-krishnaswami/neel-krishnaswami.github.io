<div class="highlight"><pre><span class="k">val</span> <span class="n">map</span> <span class="o">:</span> <span class="err">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">.</span> <span class="err">□</span><span class="o">(</span><span class="n">a</span> <span class="err">→</span> <span class="n">b</span><span class="o">)</span> <span class="err">→</span> <span class="n">stream</span> <span class="n">a</span> <span class="err">→</span> <span class="n">stream</span> <span class="n">b</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">map</span> <span class="err">□</span><span class="n">f</span> <span class="o">(</span><span class="n">x</span> <span class="o">::</span> <span class="n">xs</span><span class="o">)</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x</span> <span class="o">::</span> <span class="n">map</span> <span class="o">(</span><span class="err">□</span><span class="n">f</span><span class="o">)</span> <span class="n">xs</span>

<span class="k">val</span> <span class="n">unfold</span> <span class="o">:</span> <span class="err">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">.</span> <span class="err">□</span><span class="o">(</span><span class="n">a</span> <span class="err">→</span> <span class="n">b</span> <span class="err">×</span> <span class="err">•</span><span class="n">a</span><span class="o">)</span> <span class="err">→</span> <span class="n">a</span> <span class="err">→</span> <span class="n">stream</span> <span class="n">b</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">unfold</span> <span class="err">□</span><span class="n">f</span> <span class="n">seed</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="err">•</span><span class="n">seed</span><span class="o">)</span> <span class="o">=</span> <span class="n">f</span> <span class="n">seed</span> <span class="k">in</span>
  <span class="n">v</span> <span class="o">::</span> <span class="n">unfold</span> <span class="o">(</span><span class="err">□</span><span class="n">f</span><span class="o">)</span> <span class="n">seed</span>

<span class="k">val</span> <span class="n">count</span> <span class="o">:</span> <span class="n">stream</span> <span class="kt">bool</span> <span class="err">→</span> <span class="n">stream</span> <span class="n">num</span>
<span class="k">let</span> <span class="n">count</span> <span class="n">bs</span> <span class="o">=</span>
  <span class="n">unfold</span>
    <span class="o">(</span><span class="err">□</span><span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="o">(</span><span class="n">b</span> <span class="o">::</span> <span class="n">bs</span><span class="o">))</span> <span class="err">→</span>
         <span class="k">let</span> <span class="n">m</span> <span class="o">:</span> <span class="n">num</span> <span class="o">=</span> <span class="k">if</span> <span class="n">b</span> <span class="k">then</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="k">else</span> <span class="n">n</span> <span class="k">in</span> 
         <span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="err">•</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">bs</span><span class="o">))))</span>
    <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">bs</span><span class="o">)</span>

<span class="k">val</span> <span class="n">dynlabel</span> <span class="o">:</span> <span class="n">stream</span> <span class="kt">string</span> <span class="err">→</span> <span class="nc">G</span><span class="o">(</span><span class="err">∃</span><span class="n">a</span><span class="o">.</span> <span class="n">dom</span> <span class="n">a</span><span class="o">)</span>
<span class="k">let</span> <span class="n">dynlabel</span> <span class="n">msgs</span> <span class="o">=</span>
  <span class="nc">G</span><span class="o">(</span><span class="k">val</span> <span class="n">update</span> <span class="o">:</span> <span class="err">∀</span> <span class="n">a</span><span class="o">.</span> <span class="nc">F</span><span class="o">(</span><span class="n">stream</span> <span class="kt">string</span><span class="o">)</span> <span class="err">⊸</span> <span class="n">dom</span> <span class="n">a</span> <span class="err">⊸</span> <span class="n">dom</span> <span class="n">a</span> 
    <span class="k">let</span> <span class="k">rec</span> <span class="n">update</span> <span class="o">(</span><span class="nc">F</span><span class="o">(</span><span class="n">s</span> <span class="o">::</span> <span class="n">ss</span><span class="o">))</span> <span class="n">w</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">w</span> <span class="o">=</span> <span class="n">run</span> <span class="o">(</span><span class="n">text</span> <span class="n">s</span><span class="o">)</span> <span class="n">w</span> <span class="k">in</span> 
      <span class="k">let</span> <span class="o">(</span><span class="n">w0</span><span class="o">,</span> <span class="err">•</span><span class="n">w1</span><span class="o">)</span> <span class="o">=</span> <span class="n">run</span> <span class="n">split</span> <span class="n">w</span> <span class="k">in</span>
      <span class="n">run</span> <span class="n">merge</span> <span class="o">(</span><span class="n">w0</span><span class="o">,</span> <span class="err">•</span><span class="o">(</span><span class="n">update</span> <span class="o">(</span><span class="nc">F</span> <span class="n">ss</span><span class="o">)</span> <span class="n">w1</span><span class="o">))</span>
    <span class="k">in</span>
    <span class="k">let</span> <span class="n">w</span> <span class="o">=</span> <span class="n">run</span> <span class="o">(</span><span class="n">mkText</span> <span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="k">in</span> 
    <span class="n">update</span> <span class="o">(</span><span class="nc">F</span> <span class="n">msgs</span><span class="o">)</span> <span class="n">w</span><span class="o">)</span>

<span class="k">val</span> <span class="n">main</span> <span class="o">:</span> <span class="nc">G</span><span class="o">(</span><span class="err">∃</span><span class="n">a</span><span class="o">.</span> <span class="n">dom</span> <span class="n">a</span><span class="o">)</span>
<span class="k">let</span> <span class="n">main</span> <span class="o">=</span>
  <span class="nc">G</span><span class="o">(</span><span class="k">let</span> <span class="n">w</span> <span class="o">=</span> <span class="n">run</span> <span class="n">mkButton</span> <span class="k">in</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="nc">F</span> <span class="n">bs</span><span class="o">)</span> <span class="o">=</span> <span class="n">run</span> <span class="n">clicks</span> <span class="n">w</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">run</span> <span class="o">(</span><span class="n">dynlabel</span> <span class="o">(</span><span class="n">map</span> <span class="o">(</span><span class="err">□</span><span class="n">toString</span><span class="o">)</span> <span class="o">(</span><span class="n">count</span> <span class="n">bs</span><span class="o">)))</span> <span class="k">in</span>
    <span class="n">run</span> <span class="n">attach</span> <span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">w0</span><span class="o">))</span>  

<span class="k">in</span> <span class="n">main</span> 
</pre></div>
